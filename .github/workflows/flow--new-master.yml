name: Build the CIMonitor latest container
on:
  push:
    branches:
      - master
jobs:
  test:
    name: Test
    uses: ./.github/workflows/job--test-and-lint.yml

  server:
    name: Server
    uses: ./.github/workflows/job--build-and-tag.yml
    needs: test
    with:
      BASE_IMAGE: node:16-slim
      DOCKER_DIRECTORY: docker/server
      DOCKER_IMAGE: cimonitor/server:latest
    secrets:
      DOCKER_USERNAME: ${{ secrets.DOCKER_USERNAME }}
      DOCKER_TOKEN: ${{ secrets.DOCKER_TOKEN }}

  server-arm:
    name: Server ARM
    uses: ./.github/workflows/job--build-and-tag.yml
    needs: test
    with:
      BASE_IMAGE: arm32v7/node:16-slim
      DOCKER_DIRECTORY: docker/server
      DOCKER_IMAGE: cimonitor/server:latest-arm
      QEMU_ARCH: arm
    secrets:
      DOCKER_USERNAME: ${{ secrets.DOCKER_USERNAME }}
      DOCKER_TOKEN: ${{ secrets.DOCKER_TOKEN }}

  module-client:
    name: Module client
    uses: ./.github/workflows/job--build-and-tag.yml
    needs: test
    with:
      BASE_IMAGE: node:16-slim
      DOCKER_DIRECTORY: docker/module-client
      DOCKER_IMAGE: cimonitor/module-client:latest
    secrets:
      DOCKER_USERNAME: ${{ secrets.DOCKER_USERNAME }}
      DOCKER_TOKEN: ${{ secrets.DOCKER_TOKEN }}

  module-client-arm:
    name: Module client ARM
    uses: ./.github/workflows/job--build-and-tag.yml
    needs: test
    with:
      BASE_IMAGE: arm32v7/node:16-slim
      DOCKER_DIRECTORY: docker/module-client
      DOCKER_IMAGE: cimonitor/module-client:latest-arm
      QEMU_ARCH: arm
    secrets:
      DOCKER_USERNAME: ${{ secrets.DOCKER_USERNAME }}
      DOCKER_TOKEN: ${{ secrets.DOCKER_TOKEN }}
